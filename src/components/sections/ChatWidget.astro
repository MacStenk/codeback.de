---
// ChatWidget.astro - Briefing Chat fÃ¼r CodeBack.de
---

<div id="chat-widget-container"></div>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  // === CONFIG ===
  const OPENAI_API_KEY = import.meta.env.PUBLIC_OPENAI_API_KEY;
  const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
  const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // === SYSTEM PROMPT ===
  const SYSTEM_PROMPT = `Du bist der Briefing-Agent fÃ¼r CodeBack.de.

DEINE ROLLE:
- Freundlicher, professioneller GesprÃ¤chspartner
- Sammle Briefing-Informationen systematisch
- Qualifiziere Leads (Budget >â‚¬2.500, realistische Timeline)

GESPRÃ„CHSSTIL:
- Kurze Messages (max 2 SÃ¤tze)
- Eine Frage nach der anderen
- Freundlich aber direkt

ABLAUF:
1. BegrÃ¼ÃŸung & Name
2. Business & Zielgruppe
3. Website-Status
4. Budget-Range
5. Timeline
6. Hauptziele
7. Qualifizierung

START MESSAGE:
"Hi! ðŸ‘‹ Ich bin der CodeBack Briefing-Agent. Wie heiÃŸt du?"`;

  // === STATE ===
  let messages: Array<{role: string, content: string}> = [];
  let isOpen = false;
  
  // === VECTOR SEARCH ===
  async function searchKnowledge(query: string): Promise<string> {
    // Create embedding for query
    const embeddingResponse = await fetch('https://api.openai.com/v1/embeddings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'text-embedding-3-small',
        input: query
      })
    });
    
    const embeddingData = await embeddingResponse.json();
    const embedding = embeddingData.data[0].embedding;
    
    // Search Supabase
    const { data, error } = await supabase.rpc('match_documents', {
      query_embedding: embedding,
      match_count: 3
    });
    
    if (error) {
      console.error('Vector search error:', error);
      return '';
    }
    
    // Combine results
    return data?.map((d: any) => d.content).join('\n\n') || '';
  }
  
  // === CHAT ===
  async function sendMessage(userMessage: string): Promise<string> {
    // Add to history
    messages.push({ role: 'user', content: userMessage });
    
    // Search knowledge base
    const context = await searchKnowledge(userMessage);
    
    // Build messages with context
    const chatMessages = [
      { role: 'system', content: SYSTEM_PROMPT },
      ...(context ? [{ role: 'system', content: `Kontext aus Knowledge Base:\n${context}` }] : []),
      ...messages
    ];
    
    // Call OpenAI
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: chatMessages,
        temperature: 0.7,
        max_tokens: 300
      })
    });
    
    const data = await response.json();
    const assistantMessage = data.choices[0].message.content;
    
    // Add to history
    messages.push({ role: 'assistant', content: assistantMessage });
    
    return assistantMessage;
  }
  
  // === UI ===
  function createUI() {
    const container = document.getElementById('chat-widget-container');
    if (!container) return;
    
    // Chat Button
    const button = document.createElement('button');
    button.id = 'chat-button';
    button.innerHTML = 'ðŸ’¬';
    button.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #16a34a;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      transition: transform 0.2s;
    `;
    button.onmouseover = () => button.style.transform = 'scale(1.1)';
    button.onmouseout = () => button.style.transform = 'scale(1)';
    
    // Chat Window
    const chat = document.createElement('div');
    chat.id = 'chat-window';
    chat.style.cssText = `
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 400px;
      height: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 999;
    `;
    
    chat.innerHTML = `
      <div style="padding: 20px; background: #16a34a; color: white; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;">CodeBack Briefing</h3>
        <button id="close-chat" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
      </div>
      <div id="messages" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;"></div>
      <div style="padding: 20px; border-top: 1px solid #e5e7eb;">
        <div style="display: flex; gap: 8px;">
          <input id="message-input" type="text" placeholder="Schreib eine Nachricht..." style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;" />
          <button id="send-button" style="padding: 12px 20px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Senden</button>
        </div>
      </div>
    `;
    
    container.appendChild(button);
    container.appendChild(chat);
    
    // Event Listeners
    button.onclick = () => {
      isOpen = !isOpen;
      chat.style.display = isOpen ? 'flex' : 'none';
      if (isOpen && messages.length === 0) {
        addBotMessage(SYSTEM_PROMPT.split('START MESSAGE:\n')[1].replace(/"/g, ''));
      }
    };
    
    document.getElementById('close-chat')!.onclick = () => {
      isOpen = false;
      chat.style.display = 'none';
    };
    
    const input = document.getElementById('message-input') as HTMLInputElement;
    const sendBtn = document.getElementById('send-button')!;
    
    const handleSend = async () => {
      const text = input.value.trim();
      if (!text) return;
      
      addUserMessage(text);
      input.value = '';
      
      const response = await sendMessage(text);
      addBotMessage(response);
    };
    
    sendBtn.onclick = handleSend;
    input.onkeypress = (e) => {
      if (e.key === 'Enter') handleSend();
    };
  }
  
  function addUserMessage(text: string) {
    const messagesDiv = document.getElementById('messages')!;
    const msg = document.createElement('div');
    msg.style.cssText = 'align-self: flex-end; background: #16a34a; color: white; padding: 12px 16px; border-radius: 12px 12px 0 12px; max-width: 70%;';
    msg.textContent = text;
    messagesDiv.appendChild(msg);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
  
  function addBotMessage(text: string) {
    const messagesDiv = document.getElementById('messages')!;
    const msg = document.createElement('div');
    msg.style.cssText = 'align-self: flex-start; background: #f3f4f6; color: #1f2937; padding: 12px 16px; border-radius: 12px 12px 12px 0; max-width: 70%;';
    msg.textContent = text;
    messagesDiv.appendChild(msg);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
  
  // Init
  createUI();
</script>

<style>
  #chat-widget-container {
    font-family: system-ui, -apple-system, sans-serif;
  }
  
  #messages::-webkit-scrollbar {
    width: 6px;
  }
  
  #messages::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  
  #messages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }
</style>
