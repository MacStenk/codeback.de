---
// verify.astro - Email Verification Success Page
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Email Best√§tigung | CodeBack.de">
  <div class="verify-container">
    <div id="loading" class="verify-card">
      <div class="spinner"></div>
      <h1>Email wird best√§tigt...</h1>
      <p>Einen Moment bitte</p>
    </div>

    <div id="success" class="verify-card hidden">
      <div class="success-icon">‚úÖ</div>
      <h1>Email erfolgreich best√§tigt!</h1>
      <p class="lead">Vielen Dank, <strong id="userName"></strong>!</p>
      
      <div class="info-box">
        <h3>üìß Was passiert jetzt?</h3>
        <ul>
          <li>Du erh√§ltst sofort eine Email mit den n√§chsten Schritten</li>
          <li>Ich melde mich innerhalb von 24 Stunden bei dir</li>
          <li>Optional: Buche direkt einen Termin</li>
        </ul>
      </div>

      <div class="actions">
        <a href="https://calendly.com/codeback" class="btn-primary">üìÖ Termin buchen</a>
        <a href="/" class="btn-secondary">‚Üê Zur√ºck zur Startseite</a>
      </div>
    </div>

    <div id="error" class="verify-card hidden">
      <div class="error-icon">‚ùå</div>
      <h1>Best√§tigung fehlgeschlagen</h1>
      <p class="error-message" id="errorMessage">Der Best√§tigungslink ist ung√ºltig oder abgelaufen.</p>
      
      <div class="actions">
        <a href="/" class="btn-secondary">‚Üê Zur√ºck zur Startseite</a>
      </div>
    </div>

    <div id="already-verified" class="verify-card hidden">
      <div class="info-icon">‚ÑπÔ∏è</div>
      <h1>Email bereits best√§tigt</h1>
      <p class="lead">Deine Email-Adresse wurde bereits best√§tigt, <strong id="userNameAlready"></strong>!</p>
      
      <div class="info-box">
        <p>Falls du noch keine Best√§tigungs-Email erhalten hast, check bitte deinen Spam-Ordner oder melde dich direkt bei mir.</p>
      </div>

      <div class="actions">
        <a href="mailto:hi@codeback.de" class="btn-primary">üìß Kontakt aufnehmen</a>
        <a href="/" class="btn-secondary">‚Üê Zur√ºck zur Startseite</a>
      </div>
    </div>
  </div>
</PageLayout>

<style>
  .verify-container {
    min-height: 70vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .verify-card {
    max-width: 600px;
    width: 100%;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
    padding: 3rem;
    text-align: center;
  }

  .hidden {
    display: none !important;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #f3f4f6;
    border-top-color: #16a34a;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 2rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .success-icon, .error-icon, .info-icon {
    font-size: 72px;
    margin-bottom: 1rem;
  }

  h1 {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #111827;
  }

  .lead {
    font-size: 1.125rem;
    color: #6b7280;
    margin-bottom: 2rem;
  }

  .error-message {
    color: #dc2626;
    margin-bottom: 2rem;
  }

  .info-box {
    background: #f9fafb;
    border-left: 4px solid #16a34a;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: left;
    margin: 2rem 0;
  }

  .info-box h3 {
    margin-top: 0;
    color: #16a34a;
    font-size: 1.125rem;
  }

  .info-box ul {
    margin: 0.5rem 0 0 0;
    padding-left: 1.5rem;
  }

  .info-box li {
    margin: 0.5rem 0;
    color: #374151;
  }

  .info-box p {
    margin: 0;
    color: #374151;
  }

  .actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn-primary, .btn-secondary {
    display: inline-block;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #16a34a;
    color: white;
  }

  .btn-primary:hover {
    background: #15803d;
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: #f3f4f6;
    color: #374151;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  @media (min-width: 640px) {
    .actions {
      flex-direction: row;
      justify-content: center;
    }
  }
</style>

<script>
  // Get token from URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  const loading = document.getElementById('loading')!;
  const success = document.getElementById('success')!;
  const error = document.getElementById('error')!;
  const alreadyVerified = document.getElementById('already-verified')!;

  async function verifyEmail() {
    if (!token) {
      showError('Kein Best√§tigungstoken gefunden');
      return;
    }

    try {
      const response = await fetch(`/api/verify-email?token=${token}`);
      const data = await response.json();

      loading.classList.add('hidden');

      if (response.ok && data.verified) {
        if (data.alreadyVerified) {
          document.getElementById('userNameAlready')!.textContent = data.lead.name;
          alreadyVerified.classList.remove('hidden');
        } else {
          document.getElementById('userName')!.textContent = data.lead.name;
          success.classList.remove('hidden');
        }
      } else {
        showError(data.error || 'Best√§tigung fehlgeschlagen');
      }
    } catch (err) {
      console.error('Verification error:', err);
      showError('Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.');
    }
  }

  function showError(message: string) {
    loading.classList.add('hidden');
    document.getElementById('errorMessage')!.textContent = message;
    error.classList.remove('hidden');
  }

  // Start verification on page load
  verifyEmail();
</script>
